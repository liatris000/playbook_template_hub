# CRM -> 既存SaaS 連携仕様テンプレ（成約時）

このテンプレは、新規 B型支援CRM から既存 B型支援SaaS へ「成約確定データ」を引き継ぐための契約を定義します。

## 1. 連携目的

- 成約確定時に、既存SaaS 側で顧客管理を開始できる状態を作る
- 手作業の二重入力をなくす
- 再送や重複送信が起きてもデータを壊さない

## 2. 連携トリガー

| イベント | 発火条件 | 備考 |
|---|---|---|
| `deal.won` | CRMで成約確定が完了した時点 | このイベントのみ必須 |
| `deal.won.cancelled` | 成約取消が確定した時点 | 必要な場合のみ実装 |

## 3. 連携方式

- 推奨: Webhook push（準リアルタイム）
- 代替: 定期バッチ pull
- いずれでも `idempotency_key` を必須にする

## 4. ペイロード契約（最小）

```json
{
  "event_type": "deal.won",
  "event_id": "evt_20260226_xxx",
  "occurred_at": "2026-02-26T09:00:00Z",
  "idempotency_key": "deal_won_12345_v1",
  "source": "b-support-crm",
  "lead": {
    "external_lead_id": "lead_12345",
    "name": "山田 太郎",
    "phone": "09012345678",
    "email": "sample@example.com"
  },
  "deal": {
    "deal_id": "deal_98765",
    "won_at": "2026-02-26T08:55:00Z",
    "owner_id": "user_001"
  }
}
```

## 5. 必須契約

- `external_lead_id`: CRM 側で一意
- `idempotency_key`: 再送時に同一キーを使う
- `event_id`: 監査追跡用（一意）
- `occurred_at`: 発生時刻（UTC）

## 6. エラーハンドリング

| ケース | CRM の挙動 | SaaS の挙動 |
|---|---|---|
| 4xx（入力不正） | 送信停止し手動調査キューへ | エラー理由を返す |
| 5xx（受信側障害） | 指数バックオフで再送 | 復旧後に重複を吸収 |
| タイムアウト | 再送キューへ積む | 冪等で再受信可能にする |

## 7. セキュリティ

- 署名検証（HMAC）または同等の送信元検証を行う
- PII は必要最小限のみ送る
- 連携ログに個人情報を平文で残しすぎない

## 8. テスト項目（最低限）

- 正常系: `deal.won` 1回送信で SaaS に1件作成される
- 再送系: 同一 `idempotency_key` で二重作成されない
- 異常系: 5xx 時に再送され、最終的に整合する
- 異常系: 4xx 時に再送ループせず、運用キューへ回る

## 9. 運用項目

- 失敗通知チャネル
- 再送上限回数
- 手動リカバリ手順
- 監査ログ保持期間
