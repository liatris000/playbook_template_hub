# マイグレーション事故防止プレイブック

このドキュメントは、DB マイグレーションでの障害や手戻りを減らすための手順をまとめたものです。  
今は未導入でも、別案件で最初から入れるべき施策を含みます。

## 事故を防ぐ基本原則

- 破壊的変更は最後に行う（Additive First）
- スキーマ変更とアプリ変更を同時リリースしない
- ロールバック手段がない変更は本番適用しない
- 型定義とテストを同時更新してズレを残さない

## 必須ステップ（実施順）

1. 変更設計
   - 変更目的、影響テーブル、影響 API、ロールバック方法を Issue/PR に明記する
   - `Non-scope` と `Allowed Directories` を固定する
2. SQL 作成
   - 1 migration = 1責務で分割する
   - テーブル削除/列削除/型変更は即時実施せず、互換期間を設ける
3. ローカル検証
   - `supabase db reset` で初期状態から適用確認
   - 既存機能の主要 API テストを実行
4. 型・実装同期
   - 型生成（`database.types.ts` 相当）を更新
   - 実装 + 型 + テストを同一PRで揃える
5. リリース前検証
   - `npm run lint` / `npm test` / `npm run build` を通す
   - 本番想定環境変数で起動確認
6. 本番適用
   - 低トラフィック時間帯で適用する
   - 失敗時の戻し手順（再デプロイ/復元）を事前に担当者共有する
7. 適用後監視
   - エラーレート、認証失敗、主要 API レイテンシを確認する
   - 異常時は即時ロールバック判断を行う

## 実装パターン（推奨）

### 2段階移行（安全）

1. 追加のみ: 新カラム/新テーブルを追加し、旧実装は維持
2. 互換運用: 新旧両方を読める実装にする
3. 切替完了後: 旧カラム参照を削除
4. 最終段階で削除 migration を適用

### 避けるべきパターン

- 旧カラムを即削除して同じPRで実装を切り替える
- migration 適用後に型更新を忘れる
- テストなしで本番に先行適用する

## RLS 専用チェック（Supabase）

- 新規テーブル作成時に RLS 有効化を同じ migration で行う
- `SELECT/INSERT/UPDATE/DELETE` の4操作を明示し、抜けをなくす
- `USING` と `WITH CHECK` の条件差分をレビューで確認する
- 拒否系テスト（権限なしユーザー）を必ず含める
- 詳細テンプレ: [supabase-rls-template.md](../security/supabase-rls-template.md)

## 今は未実施でも導入推奨の施策

- CI に「migration smoke job」を追加（空DBに毎回全 migration を適用）
- CI に「schema drift 検知」を追加（DB 実態と migration 差分チェック）
- 破壊的 SQL を検知する静的チェック（`DROP COLUMN`, `ALTER TYPE` など）を追加
- 本番適用前に自動バックアップ取得を必須化
- migration freeze window（週次の適用時間帯固定）を運用化

## 導入ロードマップ（今すぐ / 次フェーズ）

### 今すぐ導入（1-2週間）

1. migration CI を2段化する
   - `空DBへの全適用` と `既存データ想定での適用` を分けて実行する
2. Expand/Contract を運用ルール化する
   - 即時の列削除/型変更を禁止し、互換期間を必須にする
3. 破壊的 SQL ガードを入れる
   - `DROP COLUMN` / `ALTER TYPE` / `DROP TABLE` 検知時はレビュー必須にする
4. RLS 回帰テストを最小セットで自動化する
   - 匿名/一般/管理者の許可・拒否ケースをCIで毎回実行する

### 次フェーズ導入（1-2ヶ月）

1. schema drift の定期検知（nightly）を追加する
2. lock影響ガードを migration 実行時に強制する
   - `statement_timeout` / `lock_timeout` を明示して長時間ロックを避ける
3. 本番復元訓練を月次実施する
   - バックアップ取得だけでなく、復元完了までを検証する
4. 本番適用後のカナリア検証を自動化する
   - 主要API成功率/403率の閾値超過時にロールバック判断を発火する
5. migration freeze window を固定運用する
   - 大きい変更は曜日・時間帯を限定して適用する

## PR 前チェックリスト

- [ ] 変更目的とロールバック手順を PR に記載した
- [ ] Additive First になっている（破壊的変更を先にしていない）
- [ ] `supabase db reset` 相当の適用確認を実施した
- [ ] 型定義・実装・テストを同時更新した
- [ ] `lint` / `test` / `build` を通した
- [ ] 監視確認ポイントを記載した
