# フェーズ分割リファクタリングプレイブック

## 概要

大規模な構造変更を複数フェーズに分割し、常に動く状態を維持しながら進める。
レビュー可能性とロールバック容易性を優先する。

## 適用条件

- ディレクトリ再編や責務分離など変更範囲が広い
- 一括変更するとレビュー負荷が高い
- 既存機能を止めずに段階移行したい

## アンチパターン

- 巨大 PR で移動・改名・機能変更を同時実施する
- 一時的に赤い状態を前提に進める
- フェーズ境界の受け入れ条件を定義しない

## 推奨パターン

1. フェーズごとに目的を 1 つへ絞る
2. 各フェーズで `lint` / `test` / `build` 緑を維持する
3. フェーズ完了条件を事前に定義する
4. 影響範囲を `Allowed Directories` で固定する

## 最小実装例

```md
Phase 1: ファイル移動のみ
- 期待: ふるまい変更なし
- 完了条件: import 解決 + 全テスト緑

Phase 2: API 境界の抽出
- 期待: 呼び出し元の型が安定
- 完了条件: 契約テスト追加 + 回帰なし

Phase 3: 不要コードの削除
- 期待: 依存簡素化
- 完了条件: カバレッジ維持 + dead code 消滅
```

## チェックリスト

- [ ] フェーズ単位で目的と非対象を明記した
- [ ] 各フェーズの完了条件を定義した
- [ ] 各フェーズを独立してロールバック可能にした
- [ ] 移動と仕様変更を同一コミットに混在させていない

## 関連テンプレート / プレイブック

- [Reuse Architecture Guide](../architecture/reuse-architecture-guide.md)
- [CI Green Policy](./ci-green-policy.md)
