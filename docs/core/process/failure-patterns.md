# 過去マージ由来の失敗パターン集

このドキュメントは、運用ログと `git log` から抽出した「再発しやすい失敗」をまとめたものです。  
別受託案件へ移植する際も、そのまま再発防止チェックとして使えます。

## 主要パターン

<!-- markdownlint-disable MD013 -->
| 失敗パターン | 実例（日時） | 典型原因 | 予防策 |
|---|---|---|---|
| 一括置換で巻き添え変更 | 2026-02-02 S2 | `replace_all` の適用範囲が広すぎる | 変更前に `rg` で対象を固定し、小分けコミットに分割 |
| サブエージェントのスコープ漏れ | 2026-02-03 S2 | `tests/` や型定義ファイルを委任対象に入れ忘れ | 開始前チェックで「実装 + 型 + テスト」の3層を必須化 |
| 並列実装後のマージコンフリクト | 2026-02-15 S4 | 同一領域を複数PRが同時変更 | 着手前に衝突予測ファイルを共有し、先行マージ順を固定 |
| 型同期漏れでビルドエラー | 2026-02-24 S1 | DB型変更に `database.types.ts` 追従漏れ | スキーマ変更時に型再生成とビルドを必須ゲート化 |
| 権限/環境差分で手戻り | 2026-02-19 S3-S4 | 実行権限不足、Node/PATH 差分、モック不安定 | `env:check` 先行、権限確認、非同期テストは `waitFor` を標準化 |
<!-- markdownlint-enable MD013 -->

## 未発生でも要注意（先回りで防ぐ）

| 高リスクパターン | 想定原因 | 先回り対策 |
|---|---|---|
| RLS 抜けで過剰アクセス | 新テーブルの policy/有効化漏れ | RLS専用テンプレで4操作チェックを必須化 |
| 破壊的 migration の先行適用 | 互換期間なしで列削除/型変更 | Additive First + 2段階移行を運用化 |

## 失敗予防チェック（PR前）

- [ ] 変更ファイルに `実装・型・テスト` が揃っている
- [ ] 並列作業時は競合しうるファイル一覧を共有した
- [ ] スキーマ変更時に型再生成とビルド確認を実施した
- [ ] 失敗系テスト（401/403/400/500）を先に作成した
- [ ] 環境依存コマンドは `env:check` 後に実行した

## マージ前の最小コマンド

```bash
npm run env:check
npm run lint
npm test
npm run build
```

## 運用ルール

- 新しい失敗が発生したら、日付と原因をこのファイルに追記する
- 「原因 -> 対応 -> 再発防止」の3点セットで記録する
